<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous" />

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">

    <style>
        html,
        body {
            height: 100%;
            font-family: 'Roboto', sans-serif;
        }

        .bg-black {
            background: black;
        }

        .table> :not(caption)>*>* {
            padding: unset;
            background-color: unset;
            border-bottom-width: unset;
            box-shadow: unset;
            border-style: unset;
        }

        .text-right {
            text-align: right;
        }
    </style>

    <title>MoneyPrinter ðŸ–¨ðŸ¤‘</title>
</head>

<body class="bg-black text-white">
    <nav class="navbar navbar-dark bg-black mb-4">
        <div class="
                    container
                    d-flex
                    justify-content-between
                    align-items-center
                ">
            <a class="navbar-brand" href="#">MoneyPrinterBOT ðŸ–¨ðŸ¤‘</a>
            <div class="d-flex justify-content-end">
                <div class="ml-2">
                    Last update: <span id="lastUpdate"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-9">
                <h2 class="mt-4">BTC/USD Chart</h2>
                <div id="chartDiv" style="width: 100%; height: 100%"></div>
            </div>

            <div class="col-3">
                <h2 class="mt-4">Balance</h2>
                <table class="text-muted" style="width: 100%">
                    <tbody>
                        <tr>
                            <td>Current Balance</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="currentBalance"></div> â‚¬
                            </td>
                        </tr>
                        <tr>
                            <td>Current Coins</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="currentCoins"></div> BTC
                            </td>
                        </tr>
                    </tbody>
                </table>


                <h2 class="mt-4">Current State</h2>
                <table class="text-muted" style="width: 100%">
                    <tbody>
                        <tr>
                            <td>bid</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="currentState_bid"></div> â‚¬
                            </td>
                        </tr>
                        <tr>
                            <td>ask</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="currentState_ask"></div> â‚¬
                            </td>
                        </tr>
                        <tr>
                            <td>currentState</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="currentState"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>stateTicks</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="currentState_ticks"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>currentChangePercentage</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="currentState_currentChangePercentage"></div> %
                            </td>
                        </tr>
                    </tbody>
                </table>

                <h2 class="mt-4">
                    <span class="text-success">Buy</span> Signal State
                </h2>
                <table class="text-muted" style="width: 100%">
                    <tbody>
                        <tr>
                            <td>stateLowTriggered</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="buySignal_stateLowTriggered"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>needsTicksHighTriggered</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="buySignal_needsTicksHighTriggered"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>needsPercentageTriggered</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="buySignal_needsPercentageTriggered"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>-----</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>ticksLowAfterStateLowTriggered</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="buySignal_ticksLowAfterStateLowTriggered"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>startPriceOfRising</td>
                            <td class="text-right d-flex justify-content-end">
                                <div id="buySignal_startPriceOfRising"></div> â‚¬
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <h2 class="mt-4">Waiting for <span class="text-danger">Sell</span></h2>
        <table id="sellDataTabel" class="table table-dark table-striped table-hover">
            <thead>
                <th>STATUS</th>
                <th>BOUGHT DATE</th>
                <th class="text-right">AMOUNT</th>
                <th class="text-right">PRICE</th>
                <th class="text-right">CHART PRICE</th>
                <th class="text-right">NEED MIN PRICE</th>
                <th class="text-right">DIFFERENCE</th>
            </thead>
            <tbody></tbody>
        </table>

        <h2 class="mt-4">Last events</h2>
        <table id="lastEventsTable" class="table table-dark table-striped table-hover">
            <thead>
                <th>STATUS</th>
                <th>DATE</th>
                <th class="text-right">AMOUNT</th>
                <th class="text-right">PRICE</th>
                <th class="text-right">CHART PRICE</th>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://cdn.socket.io/4.0.2/socket.io.min.js"
        integrity="sha384-Bkt72xz1toXkj/oEiOgkQwWKbvNYxTNWMqdon3ejP6gwq53zSo48nW5xACmeDV0F"
        crossorigin="anonymous"></script>

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        const chartDiv = document.getElementById('chartDiv')
        const chart = LightweightCharts.createChart(chartDiv, {
            width: chartDiv.width,
            height: chartDiv.height,
            layout: {
                backgroundColor: '#000000',
                textColor: 'white',
            },
            grid: {
                horzLines: {
                    color: 'rgba(255,255,255,0.2)',
                },
                vertLines: {
                    color: 'rgba(255,255,255,0.2)',
                },
            },
            rightPriceScale: {
                visible: true,
                scaleMargins: {
                    top: 0.1,
                    bottom: 0.1,
                },
                mode: LightweightCharts.PriceScaleMode.Percentage,
                borderColor: 'rgba(197, 203, 206, 0.4)',
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: true,
                borderColor: 'rgba(197, 203, 206, 0.4)',
            },
        })
        var chartData = []
        let markers = []

        var lineSeries = chart.addLineSeries()
        lineSeries.setData(chartData)

        const socket = io()

        socket.on('setup', function (data) { update(data) })

        socket.on('update', function (data) { update(data) })

        const update = (data) => {
            let newChartData = []
            data.priceData.forEach((priceData) => {
                let time = new Date(priceData.timestamp)
                time.setHours(time.getHours() + 2)

                newChartData.push({
                    time: time.getTime() / 1000,
                    value: priceData.bid,
                })
            })

            chartData = newChartData
            lineSeries.setData(newChartData)

            // SELL DATA
            var tbodyRefSellDataTable = document
                .getElementById('sellDataTabel')
                .getElementsByTagName('tbody')[0]
            tbodyRefSellDataTable.innerHTML = ""

            data.orders.filter(order => order.status === 'waiting').forEach(order => {
                let newDate = new Date(order.timestamp)
                newDate.setHours(newDate.getHours() + 2)

                var newRow = tbodyRefSellDataTable.insertRow()
                var newCell = newRow.insertCell()
                var buySpan = document.createElement('span')
                buySpan.setAttribute('class', 'text-warning')
                buySpan.textContent = 'WAITING'
                newCell.appendChild(buySpan)

                var newCell2 = newRow.insertCell()
                var newText2 = document.createTextNode(
                    `${newDate.getHours()}:${newDate.getMinutes()}:${newDate.getUTCSeconds()}`
                )
                newCell2.appendChild(newText2)

                var newCell3 = newRow.insertCell()
                var newText3 = document.createTextNode(`${order.amount} BTC`)
                newCell3.setAttribute('class', 'text-right')
                newCell3.appendChild(newText3)

                var newCell4 = newRow.insertCell()
                var newText4 = document.createTextNode(`${order.price} â‚¬`)
                newCell4.setAttribute('class', 'text-right')
                newCell4.appendChild(newText4)

                var newCell5 = newRow.insertCell()
                var newText5 = document.createTextNode(`${order.chartPrice} â‚¬`)
                newCell5.setAttribute('class', 'text-right')
                newCell5.appendChild(newText5)

                var newCell6 = newRow.insertCell()
                var newText6 = document.createTextNode(`${(order.chartPrice + ((order.chartPrice * order.lowLimit) - order.chartPrice)).toFixed(2)} â‚¬`)
                newCell6.setAttribute('class', 'text-right')
                newCell6.appendChild(newText6)

                const priceDifference = (parseFloat(data.priceData[data.priceData.length - 1].ask) / parseFloat((order.chartPrice + ((order.chartPrice * order.lowLimit) - order.chartPrice)))) - parseFloat(1)
                var newCellDifference = newRow.insertCell()
                var buySpan = document.createElement('span')
                if (priceDifference >= 1) {
                    buySpan.setAttribute('class', 'text-success')
                } else {
                    buySpan.setAttribute('class', 'text-danger')
                }
                buySpan.textContent = `${priceDifference.toFixed(4)} %`

                newCellDifference.setAttribute('class', 'text-right')
                newCellDifference.appendChild(buySpan)
            })

            // LAST EVENTS
            var tbodyRefLastEventsTable = document
                .getElementById('lastEventsTable')
                .getElementsByTagName('tbody')[0]
            tbodyRefLastEventsTable.innerHTML = ""
            let newMarkers = []

            data.orders.forEach(order => {
                let newDate = new Date(order.timestamp)
                newDate.setHours(newDate.getHours() + 2)

                var newRow = tbodyRefLastEventsTable.insertRow()
                var newCell = newRow.insertCell()
                var buySpan = document.createElement('span')
                if (order.status === 'waiting') {
                    buySpan.setAttribute('class', 'text-success')
                    buySpan.textContent = 'BOUGHT'
                } else {
                    buySpan.setAttribute('class', 'text-danger')
                    buySpan.textContent = 'SOLD'
                }
                newCell.appendChild(buySpan)

                var newCell2 = newRow.insertCell()
                var newText2 = document.createTextNode(
                    `${newDate.getHours()}:${newDate.getMinutes()}:${newDate.getUTCSeconds()}`
                )
                newCell2.appendChild(newText2)

                var newCell3 = newRow.insertCell()
                newCell3.setAttribute('class', 'text-right')
                var newText3 = document.createTextNode(`${order.amount} BTC`)
                newCell3.appendChild(newText3)

                var newCell4 = newRow.insertCell()
                newCell4.setAttribute('class', 'text-right')
                var newText4 = document.createTextNode(`${order.price} â‚¬`)
                newCell4.appendChild(newText4)

                var newCell5 = newRow.insertCell()
                newCell5.setAttribute('class', 'text-right')
                var newText5 = document.createTextNode(`${order.chartPrice} â‚¬`)
                newCell5.appendChild(newText5)

                newMarkers.push({
                    time: newDate.getTime() / 1000,
                    position: 'belowBar',
                    color: '#00FF00',
                    shape: 'arrowUp',
                    text: 'Buy @ ' + Math.floor(order.chartPrice - 2),
                })
            })

            lineSeries.setMarkers(newMarkers)

            if (data.priceData.length > 0) {
                document.getElementById(
                    'currentState_bid'
                ).innerText = `${data.priceData[data.priceData.length - 1].bid}`

                document.getElementById(
                    'currentState_ask'
                ).innerText = `${data.priceData[data.priceData.length - 1].ask}`
            }

            let lastUpdateDate = new Date()
            document.getElementById(
                'lastUpdate'
            ).innerText = `${lastUpdateDate.getHours()}:${lastUpdateDate.getMinutes()}:${lastUpdateDate.getUTCSeconds()}`

            if (data.balance.totalMoney) {
                document.getElementById(
                    'currentBalance'
                ).innerText = `${data.balance.totalMoney}`

                document.getElementById(
                    'currentCoins'
                ).innerText = `${data.balance.totalCoins}`
            }
        }

        socket.on('bugSignalUpdate', function (data) {
            document.getElementById(
                'buySignal_stateLowTriggered'
            ).innerText = `${data.stateLowTriggered ? 'âœ…' : 'â›”'}`
            document.getElementById(
                'buySignal_needsTicksHighTriggered'
            ).innerText = `${data.needsTicksHighTriggered ? 'âœ…' : 'â›”'}`
            document.getElementById(
                'buySignal_needsPercentageTriggered'
            ).innerText = `${data.needsPercentageTriggered ? 'âœ…' : 'â›”'}`
            document.getElementById(
                'buySignal_ticksLowAfterStateLowTriggered'
            ).innerText = `${data.ticksLowAfterStateLowTriggered > 0 ? 'âœ…' : 'â›”'}`
            document.getElementById(
                'buySignal_startPriceOfRising'
            ).innerText = `${data.startPriceOfRising}`

            document.getElementById(
                'currentState'
            ).innerText = `${data.currentState}`
            document.getElementById(
                'currentState_ticks'
            ).innerText = `${data.stateTicks}`
            document.getElementById(
                'currentState_currentChangePercentage'
            ).innerText = `${data.currentChangePercentage}`
        })
    </script>
</body>

</html>